name: collect-dora

on:
  repository_dispatch:
    types: [dora-event]

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Ensure metrics file exists
        run: |
          if [ ! -f dora_metrics.csv ]; then
            echo "service,event,status,commit,timestamp" > dora_metrics.csv
          fi

      - name: Append DORA event
        run: |
          printf "${{ github.event.client_payload.service }},${{ github.event.client_payload.event }},${{ github.event.client_payload.status }},${{ github.event.client_payload.commit }},${{ github.event.client_payload.timestamp }}\n" >> dora_metrics.csv
          cat dora_metrics.csv

      - name: Commit and push metrics
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add dora_metrics.csv
          git commit -m "chore: record DORA event - ${{ github.event.client_payload.service }} ${{ github.event.client_payload.event }} ${{ github.event.client_payload.status }}" || echo "No changes to commit"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push

      - name: Generate DORA report
        if: always()
        run: |
          echo "# DORA Metrics Report" > DORA_REPORT.md
          echo "" >> DORA_REPORT.md
          echo "**Last updated:** $(date)" >> DORA_REPORT.md
          echo "" >> DORA_REPORT.md
          echo "## Metrics Summary" >> DORA_REPORT.md
          echo "" >> DORA_REPORT.md
          echo "### Deployment Frequency" >> DORA_REPORT.md
          echo '```' >> DORA_REPORT.md
          awk -F',' '$2=="deploy" {count++} END {print "Total deployments: " count}' dora_metrics.csv >> DORA_REPORT.md
          echo '```' >> DORA_REPORT.md
          echo "" >> DORA_REPORT.md
          echo "### Change Failure Rate" >> DORA_REPORT.md
          echo '```' >> DORA_REPORT.md
          awk -F',' 'NR>1 && $2=="deploy" {total++; if($3=="fail") failed++} END {if(total>0) print "Failure rate: " (failed/total*100) "% (" failed "/" total ")"; else print "No deployments yet"}' dora_metrics.csv >> DORA_REPORT.md
          echo '```' >> DORA_REPORT.md
          echo "" >> DORA_REPORT.md
          echo "## Full Event Log" >> DORA_REPORT.md
          echo '```' >> DORA_REPORT.md
          cat dora_metrics.csv >> DORA_REPORT.md
          echo '```' >> DORA_REPORT.md

      - name: Upload DORA report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dora-report
          path: DORA_REPORT.md

      - name: Post comment on issue (optional)
        if: github.event.client_payload.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.client_payload.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ“Š DORA Event Recorded:\n- **Service:** ${{ github.event.client_payload.service }}\n- **Event:** ${{ github.event.client_payload.event }}\n- **Status:** ${{ github.event.client_payload.status }}\n- **Commit:** ${{ github.event.client_payload.commit }}'
            })
